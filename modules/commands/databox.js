module.exports.config = {
    name: "databox",
    version: "1.0",
    hasPermssion: 0,
    credits: "Jukie",
    description: "tÃ¬m kiáº¿m thÃ´ng tin qua id cá»§a box hoáº·c ngÆ°á»i dÃ¹ng",
    commandCategory: "ThÃ´ng tin",
    usages: "databox",
    cooldowns: 5,
    
};
const request = require('request')
const fs = require('fs')
module.exports.run = async ({ event, api, args, client, Currencies, Users, utils, __GLOBAL, reminder }) => {    
    const moment = require("moment-timezone");
    const request = require("request")
    var timeNow = moment.tz("Asia/Ho_Chi_Minh").format("HH:mm:ss");
    if (!fs.existsSync(totalPath)) fs.writeFileSync(totalPath, JSON.stringify({}));
    let totalChat = JSON.parse(fs.readFileSync(totalPath));
    let threadInfo = await api.getThreadInfo(event.threadID);
    let timeByMS = Date.now();

    var memLength = threadInfo.participantIDs.length;
    let threadMem = threadInfo.participantIDs.length;
    var nameMen = [];
    var gendernam = [];
    var gendernu = [];
    var nope = [];
    for (let z in threadInfo.userInfo) {
      var gioitinhone = threadInfo.userInfo[z].gender;
      var nName = threadInfo.userInfo[z].name;
      if (gioitinhone == "MALE") {
        gendernam.push(z + gioitinhone)
      } else if (gioitinhone == "FEMALE") {
        gendernu.push(gioitinhone)
      } else {
        nope.push(nName)
      }
    };
    var nam = gendernam.length;
    var nu = gendernu.length;
    let qtv = threadInfo.adminIDs.length;
    let sl = threadInfo.messageCount;
    let u = threadInfo.nicknames;
    let icon = threadInfo.emoji;

    let threadName = threadInfo.threadName;
    let id = threadInfo.threadID;
    let sex = threadInfo.approvalMode;
    var pd = sex == false ? 'táº¯t' : sex == true ? 'báº­t' : 'Kh';


    if (!totalChat[event.threadID]) {
      totalChat[event.threadID] = {
        time: timeByMS,
        count: sl,
        ytd: 0
      }
      fs.writeFileSync(totalPath, JSON.stringify(totalChat, null, 2));
    }

    let mdtt = "ChÆ°a cÃ³ thá»‘ng kÃª";
    let preCount = totalChat[event.threadID].count || 0;
    let ytd = totalChat[event.threadID].ytd || 0;
    let hnay = (ytd != 0) ? (sl - preCount) : "ChÆ°a cÃ³ thá»‘ng kÃª";
    let hqua = (ytd != 0) ? ytd : "ChÆ°a cÃ³ thá»‘ng kÃª";
    if (timeByMS - totalChat[event.threadID].time > _24hours) {
      if (timeByMS - totalChat[event.threadID].time > (_24hours * 2)) {
        totalChat[event.threadID].count = sl;
        totalChat[event.threadID].time = timeByMS - _24hours;
        totalChat[event.threadID].ytd = sl - preCount;
        fs.writeFileSync(totalPath, JSON.stringify(totalChat, null, 2));
      }
      getHour = Math.ceil((timeByMS - totalChat[event.threadID].time - _24hours) / 3600000);
      if (ytd == 0) mdtt = 100;
      else mdtt = ((((hnay) / ((hqua / 24) * getHour))) * 100).toFixed(0);
      mdtt += "%";
    }
    
    var callback = () =>
      api.sendMessage({
        body: `Â» TÃªn box: ${threadName}\nÂ» ID Box: ${id}\nÂ» PhÃª duyá»‡t: ${pd}\nÂ» Emoji: ${icon}\nÂ» ThÃ´ng tin:\nÂ» Tá»•ng ${threadMem} thÃ nh viÃªn\nÂ» ðŸ‘¨â€ðŸ¦°Nam: ${nam} thÃ nh viÃªn \nÂ» ðŸ‘©â€ðŸ¦°Ná»¯: ${nu} thÃ nh viÃªn\nÂ» ðŸ•µï¸â€â™‚ï¸Vá»›i ${qtv} quáº£n trá»‹ viÃªn\nÂ» ðŸ’¬ Tá»•ng: ${sl} tin nháº¯n\nÂ» ðŸ“ˆ Má»©c Ä‘á»™ tÆ°Æ¡ng tÃ¡c: ${mdtt}\nðŸŒŸ Tá»•ng sá»‘ tin nháº¯n hÃ´m qua: ${hqua}\nðŸŒŸ Tá»•ng sá»‘ tin nháº¯n hÃ´m nay: ${hnay}\n   === ã€Œ${timeNow}ã€ ===`,
        attachment: fs.createReadStream(__dirname + '/cache/box.png')
      },
        threadID,
        () => fs.unlinkSync(__dirname + '/cache/box.png')
      );
    return request(encodeURI(`${threadInfo.imageSrc}`))
      .pipe(fs.createWriteStream(__dirname + '/cache/box.png'))
      .on('close', () => callback());
}
module.exports.handleEvent = async ({ api, event }) => {
  if (!fs.existsSync(totalPath)) fs.writeFileSync(totalPath, JSON.stringify({}));
  let totalChat = JSON.parse(fs.readFileSync(totalPath));
  if (!totalChat[event.threadID]) return;
  if (Date.now() - totalChat[event.threadID].time > (_24hours * 2)) {
    let sl = (await api.getThreadInfo(event.threadID)).messageCount;
    totalChat[event.threadID] = {
      time: Date.now() - _24hours,
      count: sl,
      ytd: sl - totalChat[event.threadID].count
    }
    fs.writeFileSync(totalPath, JSON.stringify(totalChat, null, 2));
  }
}